#!/bin/bash
# ulog-genconfig - regenerate udev rules and systemd service from config
# Supports multiple devices via /etc/ulog.d/*.conf

set -euo pipefail

readonly CONFIG_FILE="/etc/ulog.conf"
readonly CONFIG_DIR="/etc/ulog.d"
readonly VALID_BAUDS=(300 1200 2400 4800 9600 19200 38400 57600 115200 230400 460800 921600)

log_error() { echo "ulog-genconfig: ERROR: $*" >&2; }
log_info() { echo "ulog-genconfig: $*"; }

# Safe config parser - sets PARSED_DEVICE, PARSED_BAUD, PARSED_LOG_DIR
parse_config() {
    local config_file="$1"

    # Reset parsed values
    PARSED_DEVICE=""
    PARSED_BAUD=""
    PARSED_LOG_DIR=""

    if [[ ! -f "$config_file" ]]; then
        return 1
    fi

    local file_owner
    file_owner=$(stat -c %u "$config_file")
    if [[ "$file_owner" != "0" ]]; then
        log_error "Config file must be owned by root: $config_file"
        return 1
    fi

    while IFS='=' read -r key value || [[ -n "$key" ]]; do
        [[ -z "$key" || "$key" =~ ^[[:space:]]*# ]] && continue
        key=$(echo "$key" | xargs)
        value=$(echo "$value" | xargs)

        case "$key" in
            DEVICE)  PARSED_DEVICE="$value" ;;
            BAUD)    PARSED_BAUD="$value" ;;
            LOG_DIR) PARSED_LOG_DIR="$value" ;;
        esac
    done < "$config_file"
}

validate_device() {
    local device="$1"
    [[ "$device" =~ ^/dev/tty[A-Za-z]+[0-9]*$ ]] || return 1
    [[ ! "$device" =~ [!\"\'\`\$\(\)\{\}\[\]\|\;\&\<\>] ]] || return 1
    return 0
}

validate_dev_name() {
    local dev_name="$1"
    [[ "$dev_name" =~ ^tty[A-Za-z]+[0-9]*$ ]] || return 1
    [[ ! "$dev_name" =~ [\"\'\`\$\(\)\{\}\[\]\|\;\&\<\>\,\=] ]] || return 1
    return 0
}

validate_baud() {
    local baud="$1"
    [[ "$baud" =~ ^[0-9]+$ ]] || return 1
    for valid_baud in "${VALID_BAUDS[@]}"; do
        [[ "$baud" == "$valid_baud" ]] && return 0
    done
    return 1
}

validate_log_dir() {
    local log_dir="$1"
    [[ "$log_dir" =~ ^/ ]] || return 1
    [[ ! "$log_dir" =~ \.\. ]] || return 1
    [[ "$log_dir" =~ ^/[a-zA-Z0-9/_-]+$ ]] || return 1
    local canonical_dir
    canonical_dir=$(realpath -m "$log_dir")
    [[ "$canonical_dir" =~ ^/var/log/ ]] && return 0
    return 1
}

atomic_write() {
    local target="$1"
    local content="$2"
    local temp_file
    temp_file=$(mktemp)
    echo "$content" > "$temp_file"
    chmod 0644 "$temp_file"
    mv "$temp_file" "$target"
}

main() {
    if [[ $EUID -ne 0 ]]; then
        log_error "This script must be run as root"
        exit 1
    fi

    # Collect all devices and log directories
    declare -a devices=()
    declare -a dev_names=()
    declare -a log_dirs=()

    # Process device configs from /etc/ulog.d/
    if [[ -d "$CONFIG_DIR" ]]; then
        for config in "$CONFIG_DIR"/*.conf; do
            [[ -f "$config" ]] || continue

            parse_config "$config" || continue

            local device="$PARSED_DEVICE"
            local baud="$PARSED_BAUD"
            local log_dir="$PARSED_LOG_DIR"

            if [[ -z "$device" ]]; then
                log_error "No DEVICE in $config, skipping"
                continue
            fi

            if ! validate_device "$device"; then
                log_error "Invalid device in $config: $device"
                continue
            fi

            local dev_name
            dev_name=$(basename "$device")
            if ! validate_dev_name "$dev_name"; then
                log_error "Invalid device name: $dev_name"
                continue
            fi

            # Default log_dir
            if [[ -z "$log_dir" ]]; then
                log_dir="/var/log/ulog/$dev_name"
            fi

            if ! validate_log_dir "$log_dir"; then
                log_error "Invalid log directory in $config: $log_dir"
                continue
            fi

            devices+=("$device")
            dev_names+=("$dev_name")
            log_dirs+=("$log_dir")

            log_info "Found device: $device -> $log_dir"
        done
    fi

    # Fallback: use main config if no device configs
    if [[ ${#devices[@]} -eq 0 ]] && [[ -f "$CONFIG_FILE" ]]; then
        parse_config "$CONFIG_FILE"

        local device="$PARSED_DEVICE"
        local log_dir="$PARSED_LOG_DIR"

        if [[ -n "$device" ]] && validate_device "$device"; then
            local dev_name
            dev_name=$(basename "$device")

            if validate_dev_name "$dev_name"; then
                [[ -z "$log_dir" ]] && log_dir="/var/log/ulog/$dev_name"

                if validate_log_dir "$log_dir"; then
                    devices+=("$device")
                    dev_names+=("$dev_name")
                    log_dirs+=("$log_dir")
                    log_info "Found device: $device -> $log_dir"
                fi
            fi
        fi
    fi

    if [[ ${#devices[@]} -eq 0 ]]; then
        log_error "No valid devices configured"
        exit 1
    fi

    # Build ReadWritePaths and DeviceAllow for systemd
    # Use base log directory so subdirs can be created dynamically
    local read_write_paths="/var/lib/ulog /var/log/ulog"
    local device_allow=""
    for i in "${!devices[@]}"; do
        device_allow+="DeviceAllow=${devices[$i]} rw\n"
    done

    # Detect available serial port groups (Arch: uucp, Debian: dialout)
    local serial_groups=""
    for group in uucp dialout tty; do
        if getent group "$group" &>/dev/null; then
            [[ -n "$serial_groups" ]] && serial_groups+=" "
            serial_groups+="$group"
        fi
    done
    [[ -z "$serial_groups" ]] && serial_groups="dialout"  # fallback
    log_info "Serial port groups: $serial_groups"

    # Generate systemd service
    local service_content
    read -r -d '' service_content << EOF || true
[Unit]
Description=USB Serial Logger
After=local-fs.target

[Service]
Type=simple
ExecStart=/usr/bin/ulog
Restart=on-failure
RestartSec=5

# Security hardening
User=ulog
Group=ulog
SupplementaryGroups=${serial_groups}

# Filesystem restrictions
ProtectSystem=strict
ProtectHome=yes
PrivateTmp=yes
ReadWritePaths=${read_write_paths}
ReadOnlyPaths=/etc/ulog.conf /etc/ulog.d

# Capability restrictions
CapabilityBoundingSet=
NoNewPrivileges=yes

# Device access
PrivateDevices=no
$(echo -e "$device_allow")

# Kernel restrictions
ProtectKernelTunables=yes
ProtectKernelModules=yes
ProtectKernelLogs=yes
ProtectControlGroups=yes

# Other restrictions
RestrictAddressFamilies=AF_UNIX
RestrictRealtime=yes
MemoryDenyWriteExecute=yes
LockPersonality=yes
RestrictSUIDSGID=yes
RemoveIPC=yes

[Install]
WantedBy=multi-user.target
EOF

    atomic_write "/usr/lib/systemd/system/ulog.service" "$service_content"
    log_info "Generated: /usr/lib/systemd/system/ulog.service"

    # Generate udev rules for all devices
    local udev_content=""
    for dev_name in "${dev_names[@]}"; do
        # Set device permissions and trigger service start
        udev_content+="ACTION==\"add\", KERNEL==\"${dev_name}\", GROUP=\"ulog\", MODE=\"0660\", TAG+=\"systemd\", ENV{SYSTEMD_WANTS}=\"ulog.service\"\n"
    done

    atomic_write "/etc/udev/rules.d/99-ulog.rules" "$(echo -e "$udev_content")"
    log_info "Generated: /etc/udev/rules.d/99-ulog.rules"

    # Create state directory for session tracking
    mkdir -p /var/lib/ulog/sessions
    chown ulog:ulog /var/lib/ulog /var/lib/ulog/sessions
    chmod 0750 /var/lib/ulog /var/lib/ulog/sessions
    log_info "Created: /var/lib/ulog/sessions"

    # Create log directories
    for log_dir in "${log_dirs[@]}"; do
        mkdir -p "$log_dir"
        chown ulog:ulog "$log_dir"
        chmod 0750 "$log_dir"
        log_info "Created: $log_dir"
    done

    # Reload
    udevadm control --reload-rules
    systemctl daemon-reload

    log_info "Configuration complete for ${#devices[@]} device(s)"
}

main "$@"
